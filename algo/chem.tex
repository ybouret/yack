\documentclass[aps,12pt]{revtex4}
\usepackage[a4paper]{geometry}
\usepackage{graphicx}
\usepackage{amssymb,amsfonts,amsmath,amsthm}
\usepackage{bm}
\usepackage{pslatex}
\usepackage{mathptmx}
\usepackage{bookman}
\usepackage{chemarr}

 	 
\begin{document}

\section{Notations}

Let $A_1,\ldots,A_M$ be $M$ species involved in $N$ equilibria:
\begin{equation}
	\forall i\in[1:N], \; \sum_j \nu_{i,j} A_j = 0
\end{equation}
and
\begin{equation}
	\forall i\in[1:N], \; 
	\Gamma_i = K_i \prod_{j=1}^{M} [A_j]^{\nu^r_{ij}} 
	- \prod_{j=1}^{M} [A_j]^{\nu^p_{ij}} = 0
\end{equation}

\begin{itemize}
\item $\Gamma_i$ has the sign of $\Delta_r G_i$.
\item The unit of $\Gamma_i$ is $C_0^{\sum_j \nu^p_{ij} }$
\item The unit of $K_i$ is $C_0^{\Delta_r \nu}$
\end{itemize}


\section{Derivatives}
We express the derivative of a product w.r.t. one term:
\begin{equation}
	\partial_{A_k} \left( \prod_{j=1}^{M} [A_j]^{\nu_{j}} \right)  =
	\nu_k [A_k]^{\nu_k-1} \left( \prod_{j=1,j\not=k}^{M} [A_j]^{\nu_{j}} \right)
\end{equation}

Then:
\begin{equation}
	\partial^2_{A_k, A_k} \left( \prod_{j=1}^{M} [A_j]^{\nu_{j}} \right)  =
	\nu_k (\nu_k-1) [A_k]^{\nu_k-2} \left( \prod_{j=1,j\not=k}^{M} [A_j]^{\nu_{j}} \right)
\end{equation}
and:
\begin{equation}
	\partial^2_{A_k\not=A_l} \left( \prod_{j=1}^{M} [A_j]^{\nu_{j}} \right)  =
	\nu_k [A_k]^{\nu_k-1} \nu_l [A_l]^{\nu_l-1}\left( \prod_{j=1,j\not=k,j\not=l}^{M} [A_j]^{\nu_{j}} \right)
\end{equation}

\begin{equation}
	\vec{\Psi}_i = \partial_{\vec{C}} \Gamma_i
\end{equation}

%\section{Subtracting Equation}
%
%Let $\vec{V}_1\not=\vec{0}$ and $\vec{V}_2\not=\vec{0}$.
%The smallest weighted difference is:
%\begin{equation}
%	\delta \vec{V} = \dfrac{1}{\left(\vec{V}_1+\vec{V}_2\right)^2} \left[ 
%	\langle \vec{V}_2 | \vec{V}_1+\vec{V}_2 \rangle \vec{V}_1 - \langle \vec{V}_1 | \vec{V}_1+\vec{V}_2 \rangle \vec{V}_2
%	\right]
%\end{equation}

\section{1D-Solving}

\subsection{Solution}

Let us take $\Gamma_i$ (with a least a product or a reactant).
Then there exist a unique $\Xi_i$ for which:
\begin{equation}
\left\lbrace
\begin{array}{rcl}
	\Gamma_i(\vec{C} + \Xi_i \vec{\nu}_i ) & = & 0\\
	 \Xi_i \times \Gamma_i(\vec{C}) &\geq  &0\\
\end{array}
\right.
\end{equation}
 
Indeed, $\Xi_i$ is solution of:
\begin{equation}
	 F_i(\vec{C},X) =  K_i \prod_{j=1}^{M} \left([A_j] - X \nu^r_{ij}\right)^{\nu^r_{ij}} 
	- \prod_{j=1}^{M} \left([A_j] + X \nu^p_{ij} \right)^{\nu^p_{ij}} = 0
\end{equation} 

And each $\Xi_i$ respects all the limiting extents.


Let us set:
\begin{equation}
\left\lbrace
\begin{array}{rcll}
	P_i(\vec{C},X) & = & \displaystyle \prod_{j=1}^{M} \left([A_j] + X \nu^p_{ij} \right)^{\nu^p_{ij}}, & \partial_X P_i(\vec{C},X) > 0 \\
	\\
	R_i(\vec{C},X) & = & \displaystyle K_i \prod_{j=1}^{M} \left([A_j] - X \nu^r_{ij}\right)^{\nu^r_{ij}}, & \partial_X R_i(\vec{C},X) < 0 \\
	\\
	 F_i(\vec{C},X) & = & R_i(\vec{C},X)  - P_i(\vec{C},X), & \partial_X F_i(\vec{C},X) < 0\\
\end{array}
\right.
\end{equation}

Let
\begin{equation}
	\sigma_i = \mathrm{sign}\lbrack P_i(\vec{C},0) \rbrack
\end{equation}

\begin{itemize}

\item If $\sigma_i=0$ then $X=0$ is solution at $\vec{C}$...

\item Otherwise, we compute the limits of $F_i$.
	
	\begin{itemize}
	%%%%%%%%
	\item If $F_i$ is limited by none, then the equilibrium is \textbf{invalid}.

	%%%%%%%%
	\item If $F_i$ is limited by a reactant, meaning a "combination only" equilibrium:
		\begin{equation}
		\left\lbrace
			\begin{array}{rcl}
			P_i   & \equiv & 1\\
			X     & \in & \rbrack-\infty;\xi_r\lbrack\\
			R_i(\vec{C},\xi_r)  & = & 0 \\
 			F_i(\vec{C},\xi_r)  & = & -1 \\
			\end{array}
		\right.
		\end{equation}
		\begin{itemize}
			\item if $\sigma_i>0$, then we have $X\in\rbrack 0;\xi_r \lbrack$
			\item if $\sigma_i<0$, then we must find $\xi_0<0$ such that $F_i(\vec{C},\xi_0)>0$,
			then $X\in\rbrack \xi_0;0\lbrack$.
			We can start from $\xi_0 \approx -  K_i^{\frac{1}{\Delta_r \nu}}$ and decrease it until a total positive mass action is found.
		\end{itemize}
		
 	%%%%%%%%
 	\item If $F_i$ is limited by a product, meaning a "dissociation only" equilibrium:
	\begin{equation}
		\left\lbrace
			\begin{array}{rcl}
			R_i   & \equiv & K_i\\
			X     & \in & \rbrack \xi_p<0 ; +\infty \lbrack\\
			P_i(\vec{C},\xi_p)  & = & 0 \\
 			F_i(\vec{C},\xi_p)  & = & K_i \\
			\end{array}
		\right.
		\end{equation}

	
    	\begin{itemize}
    	\item if $\sigma_i<0$, then we must have $X\in\rbrack \xi_p;0\lbrack$.
    	\item if $\sigma_i>0$, then we must find $\xi_0>0$ such that $F_i(\vec{C},\xi_0)<0$,
    		then $X\in\rbrack 0; \xi_0 \lbrack$.
    		We can start from $\xi_0 \approx K_i^{\frac{1}{\Delta_r \nu}}$ and increase it until a total negative mass action is found.
    	\end{itemize}

	%%%%%%%%
	\item If $F_i$ is limited by both a product and a reactant, then $$X\in\rbrack \xi_p < 0 ; \xi_r > 0 \lbrack$$
	and depending on $\sigma_i$, the proper interval is chosen.
	\end{itemize}
	
\end{itemize}

\subsection{Expansion}

For any valid concentration $\vec{C}$, we have a set of single solving extents $\vec{\Xi}$.
Let's expand:

\begin{equation}
\Gamma_i(\vec{C} + \xi_i \vec{\nu}_i) \simeq (\xi_i - \Xi_i) \langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle + A_i (\xi_i - \Xi_i)^2
\end{equation}

\begin{equation}
\Gamma_i(\vec{C} + \xi_i \vec{\nu}_i + \sum_{k\not=i} \xi_k \vec{\nu}_k) \simeq 
\langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle \left[ (\xi_i - \Xi_i)  + A_i (\xi_i - \Xi_i)^2 \right] + 
\sum_{k\not=i} \langle \vec{\Psi}_{\xi_i} \vert \vec{\nu}_k \rangle \xi_k
\end{equation}
We have:
\begin{equation}
	\Xi_i - \left( - \dfrac{\Gamma_i}{\langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle}\right) =  A_i \Xi_i^2
\end{equation}


For consistency, we must have:
\begin{equation}
 \Gamma_i'(\vec{C}+\xi_i \vec{\nu}_i) \simeq \langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle \left[ 1 + 2 A_i \left(\xi_i - \Xi_i\right) \right]
 = \langle \vec{\Psi}_{\xi_i} \vert \vec{\nu}_i \rangle
\end{equation}

And we assume:
\begin{equation}
	\vec{\Psi}_{\xi_i} \simeq \left(1-\dfrac{\xi_i}{\Xi_i}\right) \vec{\Psi}_{i_0} + \dfrac{\xi_i}{\Xi_i} \vec{\Psi}_i'
\end{equation}

\begin{equation}
	\vec{\Psi}_{i_0} = \vec{\Psi}_i + \beta_i \vec{\Psi}_i'
\end{equation}


\begin{equation}
	\langle \vec{\Psi}_i \vert \vec{\nu}_i \rangle + \beta_i \langle  \vec{\Psi}_i' \vert \vec{\nu}_i \rangle
	 = \langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle \left[ 1 - 2 A_i  \Xi_i\right]
\end{equation}

The best second order approximation is:
\begin{equation}
\left\lbrace
\begin{array}{rcl}
		\Gamma_i(\vec{C}+\bm{\nu}^T \vec{\xi}) & \simeq  & 
		\langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle \left[ (\xi_i - \Xi_i)  + A_i (\xi_i - \Xi_i)^2 \right] \\
		\\
 & + & \displaystyle \sum_{k\not=i} \langle \vec{\Psi}_{i_0} \vert \vec{\nu}_k \rangle \xi_k\\
 \\
 & + & \displaystyle \sum_{k\not=i}   \dfrac{\xi_i}{\Xi_i} \langle  \vec{\Psi_i}' - \vec{\Psi}_{i_0} \vert \vec{\nu}_k \rangle \xi_k\\
\end{array}
\right.
\end{equation}

We define:
\begin{equation}
	\gamma_i(\vec{C}+\bm{\nu}^T \vec{\xi}) = \dfrac{ \Gamma_i(\vec{C}+\bm{\nu}^T \vec{\xi})}{-\langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle}
\end{equation}

\begin{equation}
\left\lbrace
\begin{array}{rcl}
	\gamma_i(\vec{C}+\bm{\nu}^T \vec{\xi})
	 &\simeq& \left(\Xi_i - \xi_i\right) - A_i \left(\Xi_i - \xi_i\right)^2\\
	 \\
	 &-& \displaystyle \sum_{k\not=i} \dfrac{\langle \vec{\Psi}_{i_0} \vert \vec{\nu}_k \rangle}{\langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle} \xi_k\\
	 \\
	 &+& \displaystyle \sum_{k\not=i}   \dfrac{\xi_i}{\Xi_i} \dfrac{\langle   \vec{\Psi}_{i_0}- \vec{\Psi_i}'  \vert \vec{\nu}_k \rangle}{\langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle} \xi_k\\
	 \\
A_i \Xi_i^2 & = & \Xi_i - \gamma_i\\
\\
\beta_i & = & 1 - 2A_i \Xi_i - \dfrac{\langle \vec{\Psi}_i \vert \vec{\nu}_i \rangle}{\langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle}\\	 
\end{array}
\right.
\end{equation}


\subsection{Expansion}

For any valid concentration $\vec{C}$, we have a set of single solving extents $\vec{\Xi}$.
Let's expand:

\begin{equation}
	\Gamma_i(\vec{C} + x \vec{\delta}_i) \simeq \Gamma_i 
	+ x \underbrace{\left[ -\Xi_i \langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle - 2 \Gamma_i \right]}_{B_i}
	+ x^2 \underbrace{\left[ \Xi_i \langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle + \Gamma_i\right]}_{A_i}
\end{equation}

\begin{equation}
	\Gamma_i(\vec{C} + \sum_k \alpha_k \vec{\delta}_k ) 
	=
	\Gamma_i \left(\vec{C} + \alpha_i \vec{\delta}_i + \sum_{k\not=i} \alpha_k \vec{\delta}_k \right)
	\simeq
	\Gamma_i(\vec{C}+\alpha_i \vec{\delta}_i) + \langle \vec{\Psi}_{\alpha_i} \vert \sum_{k\not=i} \alpha_k \vec{\delta}_k \rangle
\end{equation}
We evaluate:
\begin{equation}
	\vec{\Psi}_{\alpha_i} \simeq (1-\alpha_i) \vec{\Psi}_i + \alpha_i \vec{\Psi_i}' = \vec{\Psi}_i + \alpha_i \delta\vec{\Psi}_i
\end{equation}
and we find that the local second order expansion of $\Gamma_i$ is:
\begin{equation}
	\Gamma_i(\vec{C} + \sum_k \alpha_k \vec{\delta}_k ) 
	\simeq
	\Gamma_i +
	\left[ 
	 B_i \, \alpha_i + \sum_{k\not=i} \langle \vec{\Psi}_i \vert \vec{\delta}_k \rangle \alpha_k
	\right]
	+ \left[ A_i \, \alpha_i^2 + \alpha_i \left( \sum_{k\not=i} \langle \delta\vec{\Psi}_i \vert \vec{\delta}_k \rangle \alpha_k \right) \right]
\end{equation}

Using 
\begin{equation}
	\Gamma_i = -\beta_i^2 \Xi_i \langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle,
	\;\;B_i = (2\beta_i^2-1) \Xi_i \langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle,
	\;\;A_i = (1-\beta_i^2) \Xi_i \langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle
\end{equation}



\section{PREVIOUS}

\subsection{Evolution}

For any valid concentration $\vec{C}$, we have a set of single solving extents $\vec{\Xi}$.
We want to solve:
\begin{equation}
	\partial_t \vec{\xi} = \dfrac{1}{\delta t} \left[ \kappa \vec{\Xi} - \lambda \vec{\xi} \right]
\end{equation}
which is a stiff equation. Let us integrate using an implicit step from $\vec{0}$ to $\vec{\xi}$.
We need to find:
\begin{equation}
	\vec{\xi} = \kappa \vec{\Xi}(\vec{\xi}) - \lambda \vec{\xi}
\end{equation}

Since:
\begin{equation}
	\Gamma_i(\vec{C} + \Xi_i \vec{\nu}_i + \delta\vec{C} + \delta\Xi_i \vec{\nu}_i) = 0
\end{equation}
we expand:
\begin{equation}
	0 \simeq \langle \vec{\Psi}_i' \vert \delta\vec{C} + \delta\Xi_i \vec{\nu}_i \rangle
	+ \dfrac{1}{2} \langle  \delta\vec{C} + \delta\Xi_i \vec{\nu}_i \vert \bm{H}_i \vert  \delta\vec{C} + \delta\Xi_i \vec{\nu}_i\rangle
\end{equation}
then:
\begin{equation}
	0 = \langle \vec{\Psi}_i' \vert \delta\vec{C}\rangle + \langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle \delta \Xi_i 
	+ \dfrac{1}{2} \langle \delta\vec{C} \vert \bm{H}_i \vert \delta\vec{C} \rangle
	+ \langle \delta\vec{C} \vert \bm{H}_i \vert \vec{\nu}_i \rangle \delta \Xi_i
	+ \dfrac{\delta\Xi_i^2}{2} \langle \vec{\nu}_i \vert \bm{H}_i \vert \vec{\nu}_i \rangle
\end{equation}


and we find:
\begin{equation}
	\delta \Xi_i \simeq - \dfrac{\langle \vec{\Psi}_i' \vert \delta\vec{C}\rangle}{\langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle}
\end{equation}
so that:
\begin{equation}
	 \vec{\xi} \simeq \kappa \left[ \vec{\Xi} - \bm{\Omega}\vec{\xi} \right] - \lambda \vec{\xi}
\end{equation} 

\begin{equation}
	\left[ (1+\lambda) \bm{I}_N + \kappa \bm{\Omega} \right] \vec{\xi} = \kappa \vec{\Xi}
\end{equation}

\begin{equation}
	\left[ \bm{\Delta}_\sigma + \bm{\Omega} \right] \vec{\xi} = \vec{\Xi}
\end{equation}


\subsection{Regularization}
We define:
\begin{equation}
\vec{\Psi}_i = \partial_{\vec{C}} \Gamma_i.
\end{equation}
If $|\vec{\Psi}_i|=0$, then we solve $\Gamma_i$. If we still have $|\vec{\Psi}_i|=0$, we declare $\Gamma_i$ blocked.

\subsection{Behavior}
We have $\vec{C}_i'=\vec{C} + \vec{\delta}_i$ and $\vec{\delta}_i = \Xi_i \vec{\nu}_i$ such that:
\begin{equation}
	\Gamma_i(\vec{C}_i') = 0
\end{equation}

\begin{enumerate}
\item
\begin{equation}
	\Gamma_i(\vec{C} + x \vec{\delta}_i) \simeq (1-x) \Gamma_i
\end{equation}

\item
\begin{equation}
\begin{array}{rcl}
	\Gamma_i(\vec{C} + x  \vec{\delta}_i) & \simeq & \Gamma_i -g_i x + h_i x^2\\
	g_i & = & 2\Gamma_i + \Xi_i \langle\vec{\Psi}_i'  \vert \vec{\nu}_i \rangle\\
	h_i & = & \Gamma_i + \Xi_i \langle\vec{\Psi}_i'  \vert \vec{\nu}_i \rangle\\
\end{array}
\end{equation}

\end{enumerate}
 

 
\subsection{Evolution}
Let us start from a regular $\vec{C}$.

\begin{equation}
	\vec{\Gamma}(\vec{C}+\bm{\nu}^T \vec{\xi}) \simeq \vec{\Gamma} + \bm{\Psi} \bm{\nu}^T \vec{\xi}
\end{equation}
For a regular concentration,
\begin{equation}
	\langle\vec{\Psi}_i \vert \vec{\nu}_i\rangle < 0
\end{equation}
and is a scaling factor for $\Gamma_i$. So we want to solve
\begin{equation}
	\forall i, \;\; \langle \vec{\Omega}_i \vert \vec{\xi} \rangle = \dfrac{\Gamma_i}{-\langle\vec{\Psi}_i \vert \vec{\nu}_i\rangle}
\end{equation}
\begin{equation}
\left\lbrace
	\begin{array}{rcl}
	\Omega_{ii}   & = & 1\\
	\Omega_{i\not=j} & = & \dfrac{\langle\vec{\Psi}_i \vert \vec{\nu}_j\rangle}{\langle\vec{\Psi}_i \vert \vec{\nu}_i\rangle}\\
	\end{array}
\right.
\end{equation}

\begin{equation}
	f = \dfrac{1}{2} \vec{\Gamma}^2 \Rightarrow \vec{\nabla} f = \left(\bm{\Psi} \bm{\nu}^T\right)^T \vec{\Gamma}
\end{equation}

\begin{equation}
	f = \dfrac{1}{2} \langle \vec{\Gamma} \vert \bm{W}^2 \vert \vec{\Gamma} \rangle \Rightarrow \vec{\nabla} f = \left(\bm{W}\bm{\Psi} \bm{\nu}^T\right)^T \bm{W}\vec{\Gamma}
\end{equation}

\subsection{Moving}

Let us assume that we start from $\vec{C}$ and for each $\Gamma_i$ we know $\Xi_i$ such that $\Gamma_i(\vec{C} + \Xi_i \vec{\nu}_i) =0$
If we now move slightly by $\delta\vec{C}$, the equilibrium will react with $\delta\Xi_i$ such that:
\begin{equation}
	\Gamma_i(\vec{C} + \Xi_i \vec{\nu}_i + \delta\vec{C} + \delta\Xi_i \vec{\nu}_i) = 0
\end{equation}
and we find:
\begin{equation}
	\delta \Xi_i \simeq - \dfrac{\langle \vec{\Psi}_i' \vert \delta\vec{C}\rangle}{\langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle}
\end{equation}
 
\begin{equation}
	\rho^2(\delta\vec{C}) = \dfrac{1}{2} \sum_i \left[ \Xi_i + \delta\Xi_i \right]^2
\end{equation} 

\begin{equation}
	- \vec{\nabla} \rho^2_0 = \sum_i \dfrac{\Xi_i}{\langle \vec{\Psi}_i' \vert \vec{\nu}_i \rangle} \vec{\Psi}_i'
\end{equation}


\subsection{Global Topology}

\begin{equation}
\begin{array}{rcl}
	\Gamma_i \left(\vec{C} + \sum_k \alpha_k \vec{\delta}_k \right) & = & 
	\Gamma_i \left(\vec{C}_i' + (\alpha_i-1) \vec{\delta}_i + \sum_{k\not=i} \alpha_k \vec{\delta}_k \right)\\
	& \simeq & \langle \vec{\Psi}_i' \vert (\alpha_i-1) \vec{\delta}_i + \sum_{k\not=i} \alpha_k \vec{\delta}_k \rangle \text{ (around $\alpha_i=1$)}\\
	& \simeq & -\langle \vec{\Psi}_i'\vert \vec{\nu}_i \rangle \Xi_i + \sum_k \langle \vec{\Psi}_i'\vert \vec{\nu}_k \rangle \alpha_k \Xi_k \\
\end{array}
\end{equation}
Then
\begin{equation}
	\dfrac{\Gamma_i\left(\vec{C} + \sum_k \alpha_k \vec{\delta}_k \right)}{\langle \vec{\Psi}_i'\vert \vec{\nu}_i \rangle} \simeq
	-\Xi_i + \sum_k \Omega_{ik} \alpha_k \Xi_k
\end{equation}


\end{document}